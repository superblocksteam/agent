# Smokescreen egress proxy
# https://github.com/stripe/smokescreen
#
# Smokescreen is an HTTP CONNECT proxy that can filter outbound connections.
# It's used to intercept and control network traffic from sandbox containers.
#
# For Kubernetes/Helm deployments, the ACL config is mounted from a ConfigMap.
# For Docker Compose, the baked-in ACL file is used directly.

FROM golang:1.22-alpine AS builder

WORKDIR /app

# Install git for go mod download
RUN apk add --no-cache git

# Clone and build smokescreen
RUN git clone --depth 1 https://github.com/stripe/smokescreen.git .

# Download dependencies and build
RUN go mod download
RUN CGO_ENABLED=0 GOOS=linux go build -o smokescreen .

# Runtime stage
FROM alpine:3.19

WORKDIR /app

# Install ca-certificates for HTTPS and iptables for the init container
RUN apk add --no-cache ca-certificates iptables

# Copy the binary
COPY --from=builder /app/smokescreen .

# Create config directory and set permissions
RUN mkdir -p /etc/smokescreen && \
    chown -R 65534:65534 /etc/smokescreen && \
    chown 65534:65534 /app/smokescreen

# Copy configuration files
# For Kubernetes: ACL is overwritten by ConfigMap mount
# For Docker Compose: uses these defaults
COPY --chown=65534:65534 config/smokescreen.yaml /etc/smokescreen/config.yaml
COPY --chown=65534:65534 config/smokescreen-acl.yaml /etc/smokescreen/acl.yaml

EXPOSE 4750

# Run as nobody user (UID 65534) - iptables rules exclude this UID to avoid loops
USER 65534

CMD ["/app/smokescreen", "--config-file", "/etc/smokescreen/config.yaml"]
