---
# Docker Compose for ephemeral workers (task-manager + sandboxes)
# Used for e2e testing ephemeral Python and JavaScript execution
x-environment: &environment
  SUPERBLOCKS_AGENT_KEY: dev-agent-key
  SUPERBLOCKS_AGENT_REDIS_TOKEN: koala
  SUPERBLOCKS_AGENT_REDIS_KVSTORE_TOKEN: koala
  SUPERBLOCKS_AGENT_TLS_INSECURE: 'true'
  SUPERBLOCKS_AGENT_REDIS_HOST: redis
  SUPERBLOCKS_AGENT_REDIS_KVSTORE_HOST: redis
x-task-manager-environment: &task-manager-environment
  !!merge <<: *environment
  # Task-manager uses SUPERBLOCKS_WORKER_SANDBOX prefix for viper
  SUPERBLOCKS_WORKER_SANDBOX_TRANSPORT_REDIS_HOST: redis
  SUPERBLOCKS_WORKER_SANDBOX_TRANSPORT_REDIS_PORT: "6379"
  SUPERBLOCKS_WORKER_SANDBOX_TRANSPORT_REDIS_PASSWORD: koala
  SUPERBLOCKS_WORKER_SANDBOX_TRANSPORT_REDIS_TLS: "false"
  SUPERBLOCKS_WORKER_SANDBOX_STORE_REDIS_HOST: redis
  SUPERBLOCKS_WORKER_SANDBOX_STORE_REDIS_PORT: "6379"
  SUPERBLOCKS_WORKER_SANDBOX_STORE_REDIS_PASSWORD: koala
  SUPERBLOCKS_WORKER_SANDBOX_STORE_REDIS_TLS: "false"
  # Don't exit after one job (ephemeral=false) - allows task-manager to process multiple jobs
  SUPERBLOCKS_WORKER_SANDBOX_WORKER_EPHEMERAL: "false"
# Proxy configuration for sandboxes - routes all outbound traffic through Smokescreen
# When enabled, sandbox HTTP/HTTPS traffic goes through the proxy.
# Task-manager VariableStore is allowed through via smokescreen ACL (in allow list).
x-sandbox-proxy-environment: &sandbox-proxy-environment
  SUPERBLOCKS_WORKER_PROXY_ENABLED: "${SUPERBLOCKS_WORKER_PROXY_ENABLED:-false}"
  SUPERBLOCKS_WORKER_PROXY_HOST: "smokescreen"
  SUPERBLOCKS_WORKER_PROXY_PORT: "4750"
x-task-manager-base: &task-manager-base
  image: ghcr.io/superblocksteam/task-manager:${EPHEMERAL_IMAGE_TAG:-latest}
  build:
    context: .
    dockerfile: Dockerfile.worker.task-manager
  depends_on:
    - redis
  environment:
    !!merge <<: *task-manager-environment
  networks:
    - default
x-python-sandbox-base: &python-sandbox-base
  image: ghcr.io/superblocksteam/python-sandbox:${EPHEMERAL_IMAGE_TAG:-latest}
  build:
    context: .
    dockerfile: Dockerfile.sandbox.python
  environment:
    !!merge <<: *sandbox-proxy-environment
  networks:
    - default
x-javascript-sandbox-base: &javascript-sandbox-base
  image: ghcr.io/superblocksteam/javascript-sandbox:${EPHEMERAL_IMAGE_TAG:-latest}
  build:
    context: .
    dockerfile: Dockerfile.sandbox.javascript
  environment:
    !!merge <<: *sandbox-proxy-environment
  networks:
    - default
services:
  # Redis is shared with compose.full.yaml
  redis:
    image: ghcr.io/superblocksteam/redis:6
    ports:
      - 6379:6379
    command: --requirepass koala
    pull_policy: always
  # ============================================================================
  # Smokescreen Egress Proxy (https://github.com/stripe/smokescreen)
  # ============================================================================
  # Smokescreen is an HTTP CONNECT proxy that intercepts and controls outbound
  # connections from sandbox containers. All sandbox egress can be routed through
  # this proxy for monitoring, filtering, or redirection.
  #
  # To enable proxy for sandboxes, set: SUPERBLOCKS_WORKER_PROXY_ENABLED=true
  smokescreen:
    image: ghcr.io/superblocksteam/smokescreen:${EPHEMERAL_IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile.smokescreen
    container_name: smokescreen
    ports:
      - 4750:4750
    networks:
      - default
  # ============================================================================
  # Python Ephemeral Workers
  # ============================================================================
  python-sandbox:
    !!merge <<: *python-sandbox-base
    container_name: python-sandbox
    depends_on:
      - smokescreen
  python-ephemeral:
    !!merge <<: *task-manager-base
    container_name: python-ephemeral
    environment:
      !!merge <<: *task-manager-environment
      SUPERBLOCKS_WORKER_SANDBOX_WORKER_LANGUAGE: python
      SUPERBLOCKS_WORKER_SANDBOX_WORKER_BUCKET: BA
      SUPERBLOCKS_WORKER_SANDBOX_SANDBOX_ADDRESS: python-sandbox:50051
      SUPERBLOCKS_WORKER_SANDBOX_GRPC_ADDRESS: python-ephemeral:50050
      # Match orchestrator's ephemeral routing (--worker.ephemeral.plugins.enabled)
      SUPERBLOCKS_WORKER_SANDBOX_WORKER_STREAM_KEYS: agent.main.bucket.BA.ephemeral.plugin.python.event.execute agent.main.bucket.BE.ephemeral.plugin.python.event.execute agent.main.bucket.B1.ephemeral.plugin.python.event.execute agent.main.bucket.B2.ephemeral.plugin.python.event.execute
    depends_on:
      - redis
      - python-sandbox
  # ============================================================================
  # JavaScript Ephemeral Workers
  # ============================================================================
  javascript-sandbox:
    !!merge <<: *javascript-sandbox-base
    container_name: javascript-sandbox
    depends_on:
      - smokescreen
  javascript-ephemeral:
    !!merge <<: *task-manager-base
    container_name: javascript-ephemeral
    environment:
      !!merge <<: *task-manager-environment
      SUPERBLOCKS_WORKER_SANDBOX_WORKER_LANGUAGE: javascript
      SUPERBLOCKS_WORKER_SANDBOX_WORKER_BUCKET: BA
      SUPERBLOCKS_WORKER_SANDBOX_SANDBOX_ADDRESS: javascript-sandbox:50051
      SUPERBLOCKS_WORKER_SANDBOX_GRPC_ADDRESS: javascript-ephemeral:50050
      # Match orchestrator's ephemeral routing (--worker.ephemeral.plugins.enabled)
      SUPERBLOCKS_WORKER_SANDBOX_WORKER_STREAM_KEYS: agent.main.bucket.BA.ephemeral.plugin.javascript.event.execute agent.main.bucket.BE.ephemeral.plugin.javascript.event.execute agent.main.bucket.B1.ephemeral.plugin.javascript.event.execute agent.main.bucket.B2.ephemeral.plugin.javascript.event.execute
    depends_on:
      - redis
      - javascript-sandbox
networks:
  default:
    name: orchestrator_default
    external: true
