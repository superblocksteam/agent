{{- if .Values.gateway.enabled -}}
{{- $fullName := include "superblocks-agent.fullname" . -}}
{{- $httpPort := .Values.service.ports.http -}}
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "superblocks-agent.labels" . | nindent 4 }}
  {{- with .Values.gateway.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  gatewayClassName: {{ .Values.gateway.className }}
  listeners:
    - name: http
      protocol: {{ if .Values.gateway.tls }}HTTPS{{ else }}HTTP{{ end }}
      port: {{ .Values.gateway.listeners.http.port }}
      {{- if .Values.gateway.tls }}
      {{- if .Values.gateway.listeners.http.hostname }}
      hostname: {{ .Values.gateway.listeners.http.hostname | quote }}
      {{- end }}
      tls:
        mode: Terminate
        certificateRefs:
          {{- range .Values.gateway.tls }}
          - kind: Secret
            name: {{ .secretName }}
          {{- end }}
      {{- else }}
      {{- if .Values.gateway.listeners.http.hostname }}
      hostname: {{ .Values.gateway.listeners.http.hostname | quote }}
      {{- end }}
      {{- end }}
      allowedRoutes:
        namespaces:
          from: Same
  {{- if .Values.gateway.addresses }}
  addresses:
    {{- toYaml .Values.gateway.addresses | nindent 4 }}
  {{- end }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "superblocks-agent.labels" . | nindent 4 }}
spec:
  parentRefs:
    - name: {{ $fullName }}
      sectionName: http
  rules:
    {{- range .Values.gateway.hosts }}
    - matches:
        {{- range .paths }}
        {{- if and . (kindIs "map" .) }}
        - path:
            type: {{ default "PathPrefix" .pathType }}
            value: {{ required "gateway.hosts.paths[].path is required" .path | quote }}
        {{- else }}
        - path:
            type: PathPrefix
            value: {{ . | quote }}
        {{- end }}
        {{- end }}
      backendRefs:
        - name: {{ $fullName }}
          port: {{ $httpPort }}
    {{- end }}
---
{{- $grpcPort := .Values.service.ports.grpc -}}
{{- $services := .Values.gateway.grpcServices | default (list "/grpc.reflection.v1.ServerReflection" "/grpc.reflection.v1alpha.ServerReflection" "/api.v1.ExecutorService") }}
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: {{ $fullName }}-grpc
  labels:
    {{- include "superblocks-agent.labels" . | nindent 4 }}
  {{- with .Values.gateway.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  gatewayClassName: {{ .Values.gateway.className }}
  listeners:
    - name: grpc
      protocol: {{ if .Values.gateway.tls }}HTTPS{{ else }}HTTP{{ end }}
      port: {{ .Values.gateway.listeners.grpc.port }}
      {{- if .Values.gateway.tls }}
      {{- if .Values.gateway.listeners.grpc.hostname }}
      hostname: {{ .Values.gateway.listeners.grpc.hostname | quote }}
      {{- end }}
      tls:
        mode: Terminate
        certificateRefs:
          {{- range .Values.gateway.tls }}
          - kind: Secret
            name: {{ .secretName }}
          {{- end }}
      {{- else }}
      {{- if .Values.gateway.listeners.grpc.hostname }}
      hostname: {{ .Values.gateway.listeners.grpc.hostname | quote }}
      {{- end }}
      {{- end }}
      allowedRoutes:
        namespaces:
          from: Same
  {{- if .Values.gateway.addresses }}
  addresses:
    {{- toYaml .Values.gateway.addresses | nindent 4 }}
  {{- end }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: GRPCRoute
metadata:
  name: {{ $fullName }}-grpc
  labels:
    {{- include "superblocks-agent.labels" . | nindent 4 }}
spec:
  parentRefs:
    - name: {{ $fullName }}-grpc
      sectionName: grpc
  rules:
    {{- range .Values.gateway.hosts }}
    - matches:
        {{- range $services }}
          {{- if and . (kindIs "map" .) }}
        - method:
            service: {{ splitList "/" .path | last }}
          {{- else }}
        - method:
            service: {{ splitList "/" . | last }}
          {{- end }}
        {{- end }}
      backendRefs:
        - name: {{ $fullName }}
          port: {{ $grpcPort }}
    {{- end }}
{{- end }}
