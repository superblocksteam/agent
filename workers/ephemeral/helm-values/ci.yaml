---
# CI environment configuration for ephemeral workers
# Uses KEDA ScaledJob to process Redis stream messages
fleets:
  # Python ephemeral worker fleet
  python-test:
    language: python
    bucket: test
    consumerGroup: ephemeral-python
    keda:
      pollingInterval: 1 # Faster polling for CI
      minReplicaCount: 1 # Keep at least 1 pod warm for faster tests
      maxReplicaCount: 5
      triggers:
        - type: redis-streams
          metadata:
            address: worker-ephemeral-redis-master:6379
            stream: agent.main.bucket.test.ephemeral.plugin.python.event.execute
            consumerGroup: ephemeral-python
            lagCount: "1"
          authenticationRef:
            name: redis-auth
  # JavaScript ephemeral worker fleet
  javascript-test:
    language: javascript
    bucket: test
    consumerGroup: ephemeral-javascript
    keda:
      pollingInterval: 1 # Faster polling for CI
      minReplicaCount: 1 # Keep at least 1 pod warm for faster tests
      maxReplicaCount: 5
      triggers:
        - type: redis-streams
          metadata:
            address: worker-ephemeral-redis-master:6379
            stream: agent.main.bucket.test.ephemeral.plugin.javascript.event.execute
            consumerGroup: ephemeral-javascript
            lagCount: "1"
          authenticationRef:
            name: redis-auth
# Task Manager image (built in CI)
taskManager:
  image:
    repository: ghcr.io/superblocksteam/task-manager
    pullPolicy: IfNotPresent
# Sandbox images
sandbox:
  python:
    image:
      repository: ghcr.io/superblocksteam/python-sandbox
      pullPolicy: IfNotPresent
  javascript:
    image:
      repository: ghcr.io/superblocksteam/javascript-sandbox
      pullPolicy: IfNotPresent
# Redis configuration for CI
queue:
  deploy: true # Deploy Redis subchart for CI testing
  host: worker-ephemeral-redis-master
  port: 6379
  tls: false
  password: koala
# Disable resource limits for CI
nodeSelector: null
tolerations: null
affinity: null
# Image pull secrets (disabled for CI)
imagePullSecrets: []
# Superblocks configuration for CI
superblocks:
  key: dev-agent-key
