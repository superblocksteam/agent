---
# CI environment configuration for ephemeral workers in Kind
# Uses KEDA ScaledJob to process Redis stream messages
fleets:
  # Python ephemeral worker fleet
  python-ba:
    language: python
    bucket: BA
    consumerGroup: ephemeral-python
    streams:
      - agent.main.bucket.BA.ephemeral.plugin.python.event.execute
      - agent.main.bucket.BE.ephemeral.plugin.python.event.execute
      - agent.main.bucket.B1.ephemeral.plugin.python.event.execute
      - agent.main.bucket.B2.ephemeral.plugin.python.event.execute
    keda:
      pollingInterval: 1
      minReplicaCount: 1
      maxReplicaCount: 5
      triggers:
        - type: redis-streams
          metadata:
            address: redis-master.superblocks.svc.cluster.local:6379
            stream: agent.main.bucket.BA.ephemeral.plugin.python.event.execute
            consumerGroup: ephemeral-python
            lagCount: "1"
          authenticationRef:
            name: redis-trigger-auth
  # JavaScript ephemeral worker fleet
  javascript-ba:
    language: javascript
    bucket: BA
    consumerGroup: ephemeral-javascript
    streams:
      - agent.main.bucket.BA.ephemeral.plugin.javascript.event.execute
      - agent.main.bucket.BE.ephemeral.plugin.javascript.event.execute
      - agent.main.bucket.B1.ephemeral.plugin.javascript.event.execute
      - agent.main.bucket.B2.ephemeral.plugin.javascript.event.execute
    keda:
      pollingInterval: 1
      minReplicaCount: 1
      maxReplicaCount: 5
      triggers:
        - type: redis-streams
          metadata:
            address: redis-master.superblocks.svc.cluster.local:6379
            stream: agent.main.bucket.BA.ephemeral.plugin.javascript.event.execute
            consumerGroup: ephemeral-javascript
            lagCount: "1"
          authenticationRef:
            name: redis-trigger-auth
# Task Manager image (built in CI)
taskManager:
  image:
    repository: ghcr.io/superblocksteam/task-manager
    pullPolicy: IfNotPresent
# Sandbox images
sandbox:
  python:
    image:
      repository: ghcr.io/superblocksteam/python-lang-executor-sandbox
      pullPolicy: IfNotPresent
  javascript:
    image:
      repository: ghcr.io/superblocksteam/javascript-lang-executor-sandbox
      pullPolicy: IfNotPresent
# Redis configuration - use Bitnami Redis deployed to Kind
queue:
  deploy: false
  host: redis-master.superblocks.svc.cluster.local
  port: 6379
  tls: false
  password: koala
kvstore:
  host: redis-master.superblocks.svc.cluster.local
  port: 6379
  tls: false
  password: koala
# Disable resource limits for CI
nodeSelector: null
tolerations: null
affinity: null
# Image pull secrets (use default for CI)
imagePullSecrets: []
# Superblocks configuration for CI
superblocks:
  key: dev-agent-key
