{{- if .Values.smokescreen.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: smokescreen-config
data:
  config.yaml: |
    ---
    ip: "0.0.0.0"
    port: {{ .Values.smokescreen.port }}
    acl_file: /etc/smokescreen/acl.yaml
    {{- if .Values.smokescreen.mtls.enabled }}
    # mTLS configuration - require client certificates
    tls:
      cert_file: /etc/smokescreen/certs/server/tls.crt
      key_file: /etc/smokescreen/certs/server/tls.key
      client_ca_files:
        - /etc/smokescreen/certs/ca/ca.crt
    # Role is determined by client certificate CN
    allow_missing_role: false
    {{- else }}
    allow_missing_role: true
    {{- end }}
    unsafe_allow_private_ranges: {{ .Values.smokescreen.allowPrivateRanges | default false }}
    connect_timeout: {{ .Values.smokescreen.connectTimeout | default "10s" }}
  acl.yaml: |
    ---
    version: v1
    {{- if .Values.smokescreen.mtls.enabled }}
    # Role-based ACL - role comes from client certificate CN
    services:
      # task-manager can access everything including Redis
      - name: task-manager
        project: superblocks
        action: open
      # sandbox containers - restricted access (deny list applies)
      - name: python-sandbox
        project: superblocks
        action: open
        denied_domains:
          {{- range .Values.smokescreen.denyList }}
          - {{ . | quote }}
          {{- end }}
      - name: javascript-sandbox
        project: superblocks
        action: open
        denied_domains:
          {{- range .Values.smokescreen.denyList }}
          - {{ . | quote }}
          {{- end }}
    {{- else }}
    services: []
    {{- end }}
    default:
      name: default
      project: superblocks
      {{- if .Values.smokescreen.mtls.enabled }}
      # Enforce (block) by default if no valid certificate
      action: enforce
      {{- else }}
      action: open
      {{- end }}
    global_allow_list:
      {{- range .Values.smokescreen.allowList }}
      - {{ . | quote }}
      {{- end }}
    global_deny_list:
      {{- range .Values.smokescreen.denyList }}
      - {{ . | quote }}
      {{- end }}
{{- end }}

