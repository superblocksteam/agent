# =============================================================================
# Calico Network Policies for Ephemeral Workers
#
# Uses Calico NetworkPolicy CRD with explicit order to take precedence over
# the allow-all GlobalNetworkPolicy (which has no order).
#
# Four policies:
# 1. Task Manager Egress: RFC-1918 only (Redis, K8s API, sandbox pods - all internal)
# 2. Task Manager Ingress: Only sandbox pods on gRPC port (deny all other ingress)
# 3. Sandbox Egress: Restricted (only task-manager pods for gRPC, internet excluding private ranges)
# 4. Sandbox Ingress: Only task-manager pods on sandbox gRPC port (deny all other ingress)
#
# This provides true network isolation since task-manager and sandbox run in
# separate pods with separate NetworkPolicies.
# =============================================================================

---
# Task Manager Network Policy - Internal VPC only
# Task manager needs access to Redis, K8s API, sandbox pods, OTEL collector
# All of these are internal services - no internet access needed
apiVersion: crd.projectcalico.org/v1
kind: NetworkPolicy
metadata:
  name: task-manager-egress
  labels:
    {{- include "sandbox_workers.labels" . | nindent 4 }}
spec:
  order: 10
  selector: role == 'task-manager'
  types:
    - Egress
  egress:
    # Allow DNS (UDP and TCP)
    - action: Allow
      protocol: UDP
      destination:
        ports:
          - 53
    - action: Allow
      protocol: TCP
      destination:
        ports:
          - 53

    # Allow egress to sandbox pods (required for gRPC connection)
    - action: Allow
      protocol: TCP
      destination:
        selector: role == 'sandbox'
        ports:
          - {{ .Values.sandbox.port }}

    # Allow RFC-1918 private ranges (internal VPC)
    # Task-manager needs: Redis, K8s API, OTEL collector
    - action: Allow
      destination:
        nets:
          - 10.0.0.0/8
          - 172.16.0.0/12
          - 192.168.0.0/16

    # Deny everything else (no internet access for task-manager)
    - action: Deny

---
# Sandbox Network Policy - Restrictive egress
# Order 10 ensures this takes precedence over allow-all GlobalNetworkPolicy
apiVersion: crd.projectcalico.org/v1
kind: NetworkPolicy
metadata:
  name: sandbox-egress-deny-private
  labels:
    {{- include "sandbox_workers.labels" . | nindent 4 }}
spec:
  order: 10
  selector: role == 'sandbox'
  types:
    - Egress
  egress:
    # Allow DNS (UDP and TCP)
    - action: Allow
      protocol: UDP
      destination:
        ports:
          - 53
    - action: Allow
      protocol: TCP
      destination:
        ports:
          - 53

    # Allow task-manager pods (for gRPC variable store)
    - action: Allow
      protocol: TCP
      destination:
        selector: role == 'task-manager'
        ports:
          - {{ .Values.variableStore.grpc.port }}
          - {{ .Values.variableStore.http.port }}
          - {{ .Values.streamingProxy.grpc.port }}

    {{- if .Values.network.additionalAllowedCIDRs }}
    # Customer-specified allowed CIDRs (internal APIs, etc.)
    {{- range .Values.network.additionalAllowedCIDRs }}
    - action: Allow
      destination:
        nets:
          - {{ . }}
    {{- end }}
    {{- end }}

    # Deny all private ranges (SSRF protection)
    - action: Deny
      destination:
        nets:
          - 10.0.0.0/8
          - 172.16.0.0/12
          - 192.168.0.0/16
          - 169.254.0.0/16
          - 100.64.0.0/10

    # Allow everything else (internet)
    - action: Allow

---
# Sandbox Ingress Policy - Allow task-manager to connect for gRPC
apiVersion: crd.projectcalico.org/v1
kind: NetworkPolicy
metadata:
  name: sandbox-ingress
  labels:
    {{- include "sandbox_workers.labels" . | nindent 4 }}
spec:
  order: 10
  selector: role == 'sandbox'
  types:
    - Ingress
  ingress:
    # Allow task-manager pods to connect to sandbox gRPC port
    - action: Allow
      protocol: TCP
      source:
        selector: role == 'task-manager'
      destination:
        ports:
          - {{ .Values.sandbox.port }}
    # Deny all other ingress
    - action: Deny

---
# Task Manager Ingress Policy - Only allow sandbox to connect for gRPC
apiVersion: crd.projectcalico.org/v1
kind: NetworkPolicy
metadata:
  name: task-manager-ingress
  labels:
    {{- include "sandbox_workers.labels" . | nindent 4 }}
spec:
  order: 10
  selector: role == 'task-manager'
  types:
    - Ingress
  ingress:
    # Allow sandbox pods to connect to task-manager gRPC port (variable store)
    - action: Allow
      protocol: TCP
      source:
        selector: role == 'sandbox'
      destination:
        ports:
          - {{ .Values.variableStore.grpc.port }}
          - {{ .Values.variableStore.http.port }}
          - {{ .Values.streamingProxy.grpc.port }}
    # Deny all other ingress
    - action: Deny
