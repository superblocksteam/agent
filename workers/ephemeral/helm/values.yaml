---
# Fleets configuration - each fleet is a ScaledJob
# Example:
# fleets:
#   python-ba:
#     language: python
#     consumerGroup: ephemeral-python
#     triggerStreams:
#       - agent.main.bucket.BA.ephemeral.plugin.python.event.execute
#       - agent.main.bucket.BE.ephemeral.plugin.python.event.execute
#     streams:
#       - agent.main.bucket.BA.ephemeral.plugin.python.event.execute
#       - agent.main.bucket.BE.ephemeral.plugin.python.event.execute
#   javascript-ba:
#     language: javascript
#     bucket: BA
#     consumerGroup: ephemeral-javascript
#     # Verbatim triggers configuration
#     triggers:
#       - type: redis-streams
#         metadata:
#           address: redis:6379
#           stream: agent.main.bucket.BA.ephemeral.plugin.javascript.event.execute
#           consumerGroup: ephemeral-javascript
#           activationLagCount: "3"
fleets: {}
# Task Manager configuration
taskManager:
  image:
    repository: ghcr.io/superblocksteam/task-manager
    tag: latest
    pullPolicy: IfNotPresent
  resources:
    limits:
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi
  # Additional args to pass to the task-manager
  extraArgs: []
  # Health file path for file-based probes
  healthFilePath: /tmp/worker_healthy
  # Startup probe - checks if health file exists (created when Redis and sandbox are ready)
  startupProbe:
    exec:
      command:
        - cat
        - /tmp/worker_healthy
    failureThreshold: 30 # Allow up to 60 seconds for startup (30 * 2s)
    periodSeconds: 2
  # Readiness probe - checks if Redis and sandbox are reachable
  readinessProbe:
    exec:
      command:
        - cat
        - /tmp/worker_healthy
  # Liveness probe - checks if task-manager and sandbox are alive
  livenessProbe:
    exec:
      command:
        - cat
        - /tmp/worker_healthy
# Sandbox configurations (per language)
sandbox:
  python:
    image:
      repository: ghcr.io/superblocksteam/python-sandbox
      tag: latest
      pullPolicy: IfNotPresent
    resources:
      limits:
        memory: 2Gi
      requests:
        cpu: 100m
        memory: 256Mi
    port: 50051
    # Additional args/env for the python sandbox
    extraEnv: []
  javascript:
    image:
      repository: ghcr.io/superblocksteam/javascript-sandbox
      tag: latest
      pullPolicy: IfNotPresent
    resources:
      limits:
        memory: 2Gi
      requests:
        cpu: 100m
        memory: 256Mi
    port: 50051
    # Additional args/env for the javascript sandbox
    extraEnv: []
# KEDA ScaledJob configuration
keda:
  pollingInterval: 5
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  ttlSecondsAfterFinished: 30 # Auto-cleanup completed pods after 30 seconds
  maxReplicaCount: 100
  minReplicaCount: 0
  # Scaling strategy: "default", "custom", or "accurate"
  # "accurate" provides more precise scaling based on pending jobs
  scalingStrategy:
    strategy: accurate
  # Scaling triggers - typically Redis stream length
  triggers: []
  # Example:
  # triggers:
  #   - type: redis-streams
  #     metadata:
  #       address: redis:6379
  #       stream: sandbox:work:python
  #       consumerGroup: ephemeral-python
  #       activationLagCount: "3"
# Redis transport configuration
queue:
  deploy: false # Set to true to deploy Redis as a subchart (for local/CI testing)
  tls: false
  host: redis
  servername: ""
  port: 6379
  password: ""
  blockDuration: 5s
  batchSize: 10
  executionPool: 100
  pool:
    min: 5
    max: 10
  timeout:
    dial: 5s
    read: 5m
    write: 10s
    pool: 5m
# Redis kvstore configuration
kvstore:
  deploy: false # Set to true to deploy Redis as a subchart (for local/CI testing)
  tls: false
  host: redis
  servername: ""
  port: 6379
  password: ""
  pool:
    min: 5
    max: 10
  timeout:
    dial: 5s
    read: 5m
    write: 10s
    pool: 5m
# gRPC configuration
grpc:
  port: 50050
# Worker configuration
worker:
  group: main
  events:
    - execute
# Observability
observability:
  logging:
    level: info
  tracing:
    url: ""
    batchTimeout: 1s
    exportTimeout: 15s
    maxExportBatchSize: 1000
    maxQueueSize: 5000
# Superblocks configuration
superblocks:
  key: <override>
# Pod configuration
nodeSelector: {}
tolerations: []
affinity: {}
podAnnotations: {}
# Smokescreen egress proxy configuration
# When enabled, sandbox traffic is routed through smokescreen for filtering
smokescreen:
  enabled: true
  image:
    repository: ghcr.io/superblocksteam/smokescreen
    tag: latest
    pullPolicy: IfNotPresent
  port: 4750
  connectTimeout: 10s
  allowPrivateRanges: false
  resources:
    limits:
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi
  # Allow list - these hosts override the deny list
  # In Kubernetes, sandbox accesses task-manager via localhost (same pod sidecar)
  allowList:
    - localhost
    - "127.0.0.1"
  # Deny list - block access to internal infrastructure
  denyList:
    - python-sandbox
    - javascript-sandbox
    - agent
    - orchestrator
    - redis
    - otel-collector
    # Block Kubernetes API server (prevent SSRF to k8s control plane)
    - kubernetes.default.svc.cluster.local
    - kubernetes.default.svc
    - kubernetes.default
    - kubernetes
# Image pull secrets
image:
  credentials:
    registry: ghcr.io
    username: '<override>'
    password: '<override>'
